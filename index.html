<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Juego de Estadística Profesional</title>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome for icons (opcional) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <!-- React and ReactDOM -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">

// TODO: Pega aquí tu configuración de Firebase
var firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_DOMINIO.firebaseapp.com",
  databaseURL: "https://TU_DOMINIO.firebaseio.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_DOMINIO.appspot.com",
  messagingSenderId: "XXXXXXXXXX",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// Utilidades
function generateSessionCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
  return code;
}

const defaultTeams = [
  { id: "A", name: "Equipo A" },
  { id: "B", name: "Equipo B" },
  { id: "C", name: "Equipo C" },
  { id: "D", name: "Equipo D" },
  { id: "E", name: "Equipo E" }
];

const questions = [
  {
    question: "¿Qué representa el valor p en un estudio sobre la eficacia de un nuevo antibiótico?",
    options: [
      "La probabilidad de que el antibiótico sea efectivo",
      "La probabilidad de obtener los resultados observados si el antibiótico no tiene efecto",
      "El porcentaje de vacas que se curaron",
      "El nivel de significancia"
    ],
    correctIndex: 1,
    explanation: "El valor p representa la probabilidad de obtener los resultados observados (o más extremos) si la hipótesis nula fuera cierta."
  },
  {
    question: "En un estudio sobre el efecto de un suplemento alimenticio en el peso de terneros, se obtuvo un valor p de 0.03. ¿Qué significa esto?",
    options: [
      "El suplemento aumenta el peso en un 3%",
      "Hay un 3% de probabilidad de que el suplemento sea efectivo",
      "Hay un 3% de probabilidad de obtener estos resultados si el suplemento no tiene efecto",
      "El 3% de los terneros respondieron al suplemento"
    ],
    correctIndex: 2,
    explanation: "Un valor p de 0.03 significa que hay un 3% de probabilidad de obtener estos resultados si la hipótesis nula fuera cierta."
  },
  {
    question: "¿Qué es el valor crítico en una prueba de hipótesis?",
    options: [
      "El número mínimo de animales que deben ser vacunados",
      "El valor que determina el límite entre rechazar o no rechazar la hipótesis nula",
      "El porcentaje mínimo de eficacia que debe tener la vacuna",
      "La dosis mínima efectiva de la vacuna"
    ],
    correctIndex: 1,
    explanation: "El valor crítico es el punto de corte en la distribución de probabilidad que separa la región de rechazo de la región de no rechazo de la hipótesis nula."
  },
  {
    question: "¿Cuándo se rechaza la hipótesis nula en un estudio?",
    options: [
      "Cuando el valor p es mayor que el nivel de significancia",
      "Cuando el valor p es menor que el nivel de significancia",
      "Cuando el valor p es igual a 0.5",
      "Cuando el estadístico de prueba está dentro de la región de aceptación"
    ],
    correctIndex: 1,
    explanation: "Se rechaza la hipótesis nula cuando el valor p es menor que el nivel de significancia (α) establecido."
  }
];

const { useState, useEffect, useRef } = React;

function App() {
  const [view, setView] = useState("login");
  const [role, setRole] = useState("student");
  const [adminPass, setAdminPass] = useState("");
  const [sessionCode, setSessionCode] = useState("");
  const [studentName, setStudentName] = useState("");
  const [selectedTeam, setSelectedTeam] = useState(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedOption, setSelectedOption] = useState(null);
  const [showExplanation, setShowExplanation] = useState(false);
  const [confetti, setConfetti] = useState(false);
  const [nameError, setNameError] = useState(false);
  const [teams, setTeams] = useState([]);
  const [adminSession, setAdminSession] = useState(null);
  const [studentSession, setStudentSession] = useState(null);
  const qrRef = useRef(null);

  // Cargar datos de la sesión en tiempo real
  useEffect(() => {
    if (sessionCode) {
      const ref = db.ref('sessions/' + sessionCode);
      ref.on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          setTeams(data.teams || []);
          setAdminSession(data);
        }
      });
      return () => ref.off();
    }
  }, [sessionCode]);

  // QR dinámico
  useEffect(() => {
    if (view === "admin" && sessionCode && qrRef.current && window.QRCode) {
      qrRef.current.innerHTML = "";
      new window.QRCode(qrRef.current, {
        text: window.location.href.split('?')[0] + '?session=' + sessionCode,
        width: 128,
        height: 128
      });
    }
  }, [view, sessionCode]);

  // Leer código de sesión de la URL
  useEffect(() => {
    try {
      const params = new URLSearchParams(window.location.search);
      const session = params.get('session');
      if (session) {
        setSessionCode(session.toUpperCase());
        setRole("student");
        setView("student");
      }
    } catch (e) {}
  }, []);

  function handleLogin() {
    if (role === "admin") {
      if (adminPass === "admin123") {
        setView("admin");
      } else {
        alert("Contraseña incorrecta");
      }
    } else {
      if (sessionCode.length === 6) {
        db.ref('sessions/' + sessionCode).once('value').then(snapshot => {
          if (snapshot.exists()) {
            setView("student");
          } else {
            alert("Código de sesión no encontrado");
          }
        });
      } else {
        alert("Código de sesión inválido");
      }
    }
  }

  function handleStartSession() {
    const code = generateSessionCode();
    const session = {
      code,
      started: true,
      finished: false,
      teams: defaultTeams.map(t => ({ ...t, members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 })),
      questions,
      answers: {}
    };
    db.ref('sessions/' + code).set(session);
    setSessionCode(code);
    setView("admin");
  }

  function handleEndSession() {
    if (!sessionCode) return;
    db.ref('sessions/' + sessionCode + '/finished').set(true);
    setSessionCode("");
    setView("login");
  }

  function handleJoinTeam(teamId) {
    if (!studentName.trim()) {
      setNameError(true);
      return;
    }
    setNameError(false);
    const ref = db.ref('sessions/' + sessionCode + '/teams');
    ref.once('value').then(snapshot => {
      const teams = snapshot.val() || [];
      const updatedTeams = teams.map(t => {
        if (t.id === teamId && (!t.members || !t.members.includes(studentName))) {
          return { ...t, members: [...(t.members || []), studentName] };
        }
        if (t.members && t.members.includes(studentName)) {
          return { ...t, members: t.members.filter(n => n !== studentName) };
        }
        return t;
      });
      ref.set(updatedTeams);
      setSelectedTeam(teamId);
      setStudentSession({ code: sessionCode, teamId, name: studentName, answers: [] });
      setCurrentQuestion(0);
      setView("game");
    });
  }

  function handleAnswer(optionIdx) {
    setSelectedOption(optionIdx);
    setShowExplanation(true);
    // Actualizar puntaje en Firebase
    const ref = db.ref('sessions/' + sessionCode + '/teams');
    ref.once('value').then(snapshot => {
      const teams = snapshot.val() || [];
      const updatedTeams = teams.map(t => {
        if (t.id === selectedTeam) {
          let correct = t.correctAnswers || 0;
          let score = t.score || 0;
          if (optionIdx === questions[currentQuestion].correctIndex) {
            correct++;
            score += 10;
          }
          return {
            ...t,
            questionsAnswered: (t.questionsAnswered || 0) + 1,
            correctAnswers: correct,
            score
          };
        }
        return t;
      });
      ref.set(updatedTeams);
    });
  }

  function handleNext() {
    setShowExplanation(false);
    setSelectedOption(null);
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(q => q + 1);
    } else {
      setView("results");
      setConfetti(true);
    }
  }

  return (
    <div className="min-h-screen">
      <h1 className="text-2xl font-bold text-center my-4">Juego de Estadística</h1>
      {view === "login" && (
        <div className="max-w-md mx-auto bg-white p-6 rounded shadow">
          <label>Rol:
            <select value={role} onChange={e => setRole(e.target.value)} className="ml-2">
              <option value="admin">Administrador</option>
              <option value="student">Estudiante</option>
            </select>
          </label>
          {role === "admin" ? (
            <div className="mt-4">
              <input type="password" placeholder="Contraseña admin" value={adminPass} onChange={e => setAdminPass(e.target.value)} className="w-full p-2 border rounded" />
            </div>
          ) : (
            <>
              <div className="mt-4">
                <input type="text" placeholder="Código de sesión" value={sessionCode} onChange={e => setSessionCode(e.target.value.toUpperCase())} className="w-full p-2 border rounded" maxLength={6} />
              </div>
              <div className="mt-4">
                <input type="text" placeholder="Tu nombre" value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full p-2 border rounded" />
              </div>
            </>
          )}
          <button className="mt-4 w-full bg-blue-600 text-white p-2 rounded" onClick={handleLogin}>Ingresar</button>
        </div>
      )}
      {view === "admin" && (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow">
          <h2 className="text-xl font-bold mb-2">Panel de Administrador</h2>
          {sessionCode ? (
            <div className="mb-4 p-3 bg-gray-100 rounded flex items-center justify-between">
              <div>
                <div className="text-sm text-gray-600">Código de sesión:</div>
                <div className="font-mono text-lg font-bold">{sessionCode}</div>
              </div>
            </div>
          ) : (
            <div className="mb-4">No hay sesión activa</div>
          )}
          <div className="flex mb-4">
            <button className="bg-green-600 text-white p-2 rounded mr-2" onClick={handleStartSession}>
              {sessionCode ? 'Nueva sesión' : 'Iniciar juego'}
            </button>
            {sessionCode && (
              <button className="bg-red-600 text-white p-2 rounded" onClick={handleEndSession}>
                Finalizar sesión
              </button>
            )}
          </div>
          {sessionCode && (
            <div className="mb-4 p-3 bg-blue-50 rounded text-sm">
              <p className="font-bold">Compartir con estudiantes:</p>
              <ol className="list-decimal ml-5 mt-1">
                <li>Comparte el código: <strong>{sessionCode}</strong></li>
                <li>O comparte este enlace:
                  <div className="flex items-center mt-1">
                    <div className="font-mono bg-white p-1 text-xs break-all border rounded flex-grow mr-1">
                      {window.location.href.split('?')[0]}?session={sessionCode}
                    </div>
                  </div>
                </li>
                <li>Los estudiantes deben ingresar como "Estudiante" y usar el código</li>
              </ol>
              <div className="mt-3 p-2 bg-white border rounded text-center">
                <div className="text-xs mb-1">Código QR</div>
                <div ref={qrRef} className="mx-auto"></div>
                <div className="text-xs mt-1">Escanea para unirte como estudiante</div>
              </div>
            </div>
          )}
          <div className="mt-4">
            <h3 className="font-bold">Equipos</h3>
            <div className="grid grid-cols-2 gap-2">
              {(teams.length ? teams : defaultTeams).map(t => (
                <div key={t.id} className="border rounded p-2">
                  <div className="font-bold">{t.name}</div>
                  <div>Integrantes: {t.members ? t.members.length : 0}</div>
                  <div>Puntos: {t.score || 0}</div>
                </div>
              ))}
            </div>
          </div>
          <div className="mt-4">
            <h3 className="font-bold">Clasificación</h3>
            <table className="w-full text-sm">
              <thead><tr><th>Equipo</th><th>Puntos</th><th>Correctas</th></tr></thead>
              <tbody>
                {(teams.length ? teams : defaultTeams)
                  .slice().sort((a,b)=>(b.score||0)-(a.score||0))
                  .map(t => (
                  <tr key={t.id}><td>{t.name}</td><td>{t.score||0}</td><td>{t.correctAnswers||0}</td></tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
      {view === "student" && (
        <div className="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h2 className="text-xl font-bold mb-2">Unirse al juego</h2>
          <div className="mb-4 p-2 bg-blue-50 rounded">
            <div className="text-sm">Sesión: <span className="font-mono font-bold">{sessionCode}</span></div>
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium mb-1">Tu nombre:</label>
            <input 
              type="text" 
              placeholder="Escribe tu nombre" 
              value={studentName} 
              onChange={e => {
                setStudentName(e.target.value);
                if (e.target.value.trim()) setNameError(false);
              }} 
              className={`w-full p-2 border rounded ${nameError ? 'border-red-500' : ''}`} 
            />
            {nameError && <div className="text-red-500 text-xs mt-1">Debes ingresar tu nombre</div>}
          </div>
          <h3 className="font-bold mb-2">Selecciona tu equipo:</h3>
          <div className="grid grid-cols-2 gap-2">
            {(teams.length ? teams : defaultTeams).map(t => (
              <button 
                key={t.id} 
                className={`border rounded p-3 ${selectedTeam===t.id ? "bg-blue-200 border-blue-500" : ""}`} 
                onClick={()=>handleJoinTeam(t.id)}
              >
                <div className="font-bold">{t.name}</div>
                <div className="text-sm">{t.members ? t.members.length : 0} integrantes</div>
              </button>
            ))}
          </div>
          <div className="mt-4 text-sm text-gray-600">
            <p>1. Ingresa tu nombre</p>
            <p>2. Selecciona un equipo para comenzar</p>
          </div>
        </div>
      )}
      {view === "game" && (
        <div className="max-w-lg mx-auto bg-white p-6 rounded shadow">
          <h2 className="font-bold mb-2">Pregunta {currentQuestion+1} de {questions.length}</h2>
          <div className="mb-2 font-bold">{questions[currentQuestion].question}</div>
          <div className="grid grid-cols-1 gap-2">
            {questions[currentQuestion].options.map((opt, idx) => (
              <button key={idx} className={"border rounded p-2 text-left " + (selectedOption===idx? (idx===questions[currentQuestion].correctIndex?"bg-green-200":"bg-red-200") : "")} disabled={selectedOption!==null} onClick={()=>handleAnswer(idx)}>{opt}</button>
            ))}
          </div>
          {showExplanation && (
            <div className={selectedOption===questions[currentQuestion].correctIndex?"text-green-700 mt-2":"text-red-700 mt-2"}>
              {selectedOption===questions[currentQuestion].correctIndex?"¡Correcto!":"Incorrecto."} <br/>
              <span className="text-sm">{questions[currentQuestion].explanation}</span>
            </div>
          )}
          <div className="w-full bg-gray-200 rounded h-3 mt-4">
            <div className="bg-blue-600 h-3 rounded" style={{width:((currentQuestion+1)/questions.length*100)+"%"}}></div>
          </div>
          {showExplanation && <button className="mt-4 bg-blue-600 text-white p-2 rounded" onClick={handleNext}>{currentQuestion<questions.length-1?"Siguiente":"Ver resultado"}</button>}
        </div>
      )}
      {view === "results" && (
        <div className="max-w-lg mx-auto bg-white p-6 rounded shadow text-center">
          <h2 className="text-2xl font-bold mb-2">¡Juego finalizado!</h2>
          <div className="mb-2">Gracias por participar, <span className="font-bold">{studentName}</span> del <span className="font-bold">{defaultTeams.find(t=>t.id===selectedTeam)?.name}</span>.</div>
          <div className="mb-2">Puntaje: <span className="font-bold">{teams.find(t=>t.id===selectedTeam)?.score || 0}</span></div>
          {confetti && <Confetti />}
          <button className="mt-4 bg-blue-600 text-white p-2 rounded" onClick={()=>window.location.reload()}>Volver al inicio</button>
        </div>
      )}
    </div>
  );
}

function Confetti() {
  useEffect(() => {
    const canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = 200;
    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.pointerEvents = 'none';
    canvas.style.zIndex = 9999;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let confetti = Array.from({length:100},()=>({x:Math.random()*canvas.width,y:Math.random()*-200,color:`hsl(${Math.random()*360},70%,60%)`,r:Math.random()*6+4,speed:Math.random()*2+1}));
    let running = true;
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confetti.forEach(c=>{
        ctx.beginPath();ctx.arc(c.x,c.y,c.r,0,2*Math.PI);ctx.fillStyle=c.color;ctx.fill();
        c.y+=c.speed;
        if(c.y>canvas.height) c.y=Math.random()*-20;
      });
      if(running) requestAnimationFrame(draw);
    }
    draw();
    return ()=>{running=false;canvas.remove();};
  },[]);
  return null;
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
