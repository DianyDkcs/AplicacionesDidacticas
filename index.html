<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego de Estadística - Equipos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; }
    .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 0 15px #0001; padding: 30px; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    .team-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; }
    .team-card { background: #eaf2f8; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 5px #0001; }
    .team-name { font-weight: bold; margin-bottom: 10px; }
    .btn { padding: 10px 20px; background: #3498db; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; }
    .btn[disabled] { background: #aaa; cursor: not-allowed; }
    .hidden { display: none; }
    .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .result-table th, .result-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .result-table th { background: #3498db; color: #fff; }
    .result-table tr.winner { background: #2ecc71; color: #fff; font-weight: bold; }
    .admin-panel { text-align: center; margin-bottom: 20px; }
    .user-panel { text-align: center; margin-bottom: 20px; }
    .question-box { background: #f9f9f9; border-radius: 8px; padding: 20px; margin: 20px 0; }
    .option-btn { display: block; width: 100%; margin: 8px 0; padding: 10px; border-radius: 5px; border: 1px solid #3498db; background: #fff; cursor: pointer; }
    .option-btn.selected { background: #3498db; color: #fff; }
    .option-btn[disabled] { background: #eee; color: #aaa; cursor: not-allowed; }
    .summary { text-align: center; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Juego de Estadística - Equipos</h1>
    <div id="login-section">
      <h2>Ingresa al juego</h2>
      <div style="text-align:center;">
        <label>
          <input type="radio" name="role" value="user" checked> Participante
        </label>
        <label style="margin-left:20px;">
          <input type="radio" name="role" value="admin"> Propietario/Admin
        </label>
      </div>
      <div id="user-login" class="user-panel">
        <input id="user-name" type="text" placeholder="Tu nombre o apodo" style="margin:10px 0; padding:8px; width:80%;">
        <button class="btn" onclick="loginUser()">Entrar</button>
      </div>
      <div id="admin-login" class="admin-panel hidden">
        <input id="admin-pass" type="password" placeholder="Contraseña admin" style="margin:10px 0; padding:8px; width:80%;">
        <button class="btn" onclick="loginAdmin()">Entrar como Admin</button>
      </div>
    </div>

    <div id="team-section" class="hidden">
      <h2>Selecciona tu equipo</h2>
      <div id="teams-list" class="team-grid"></div>
    </div>

    <div id="question-section" class="hidden">
      <h2>Responde la pregunta</h2>
      <div class="question-box">
        <div id="question-text"></div>
        <div id="options-list"></div>
      </div>
      <button class="btn" id="submit-answer" onclick="submitAnswer()" disabled>Enviar respuesta</button>
    </div>

    <div id="waiting-section" class="hidden">
      <div class="summary">
        <h3>¡Gracias! Espera a que todos terminen o a que el admin finalice el juego.</h3>
      </div>
    </div>

    <div id="admin-panel" class="hidden">
      <h2>Panel de Propietario</h2>
      <button class="btn" onclick="finalizarJuego()">Finalizar juego y mostrar resultados</button>
      <div id="admin-status"></div>
    </div>

    <div id="result-section" class="hidden">
      <h2>Resultados</h2>
      <table class="result-table">
        <thead>
          <tr>
            <th>Equipo</th>
            <th>Integrantes</th>
            <th>Promedio</th>
          </tr>
        </thead>
        <tbody id="result-table-body"></tbody>
      </table>
      <div id="winner-msg" class="summary"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Configuración de Firebase (pon tus credenciales aquí)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      databaseURL: "TU_DATABASE_URL",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    // Equipos fijos
    const teamIds = ["teamA", "teamB", "teamC", "teamD", "teamE"];
    const teamNames = {
      teamA: "Equipo A",
      teamB: "Equipo B",
      teamC: "Equipo C",
      teamD: "Equipo D",
      teamE: "Equipo E"
    };

    // Pregunta de ejemplo (puedes poner más)
    const questions = [
      {
        text: "¿Qué representa el valor p en un estudio estadístico?",
        options: [
          "La probabilidad de que la hipótesis nula sea verdadera",
          "La probabilidad de obtener los resultados observados si la hipótesis nula es cierta",
          "El porcentaje de aciertos en la muestra",
          "El nivel de confianza del estudio"
        ],
        correct: 1
      }
    ];

    // Estado global
    let currentUser = null;
    let currentRole = "user";
    let selectedTeam = null;
    let currentQuestion = 0;
    let hasAnswered = false;
    let isAdmin = false;

    // Login
    document.querySelectorAll('input[name="role"]').forEach(radio => {
      radio.addEventListener('change', e => {
        if (e.target.value === "admin") {
          document.getElementById("user-login").classList.add("hidden");
          document.getElementById("admin-login").classList.remove("hidden");
        } else {
          document.getElementById("user-login").classList.remove("hidden");
          document.getElementById("admin-login").classList.add("hidden");
        }
      });
    });

    function loginUser() {
      const name = document.getElementById("user-name").value.trim();
      if (!name) { alert("Ingresa tu nombre."); return; }
      currentUser = name;
      currentRole = "user";
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("team-section").classList.remove("hidden");
      cargarEquipos();
    }

    function loginAdmin() {
      const pass = document.getElementById("admin-pass").value;
      if (pass !== "admin123") { alert("Contraseña incorrecta."); return; }
      isAdmin = true;
      currentRole = "admin";
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("admin-panel").classList.remove("hidden");
      cargarEquipos();
      actualizarAdminStatus();
    }

    // Inicializar equipos en la base si no existen
    function inicializarEquipos() {
      teamIds.forEach(teamId => {
        firebase.database().ref(`teams/${teamId}`).once('value', snap => {
          if (!snap.exists()) {
            firebase.database().ref(`teams/${teamId}`).set({
              name: teamNames[teamId],
              members: {}
            });
          }
        });
      });
    }
    inicializarEquipos();

    // Renderizar equipos
    function cargarEquipos() {
      firebase.database().ref('teams').on('value', snapshot => {
        const teamsData = snapshot.val() || {};
        const teamsList = document.getElementById('teams-list');
        if (teamsList) {
          teamsList.innerHTML = '';
          teamIds.forEach(teamId => {
            const team = teamsData[teamId] || { members: {} };
            const numIntegrantes = team.members ? Object.keys(team.members).length : 0;
            const scores = team.members ? Object.values(team.members).map(m => m.score ?? null).filter(s => s !== null) : [];
            const promedio = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            teamsList.innerHTML += `
              <div class="team-card">
                <div class="team-name">${teamNames[teamId]}</div>
                <div>Integrantes: <span id="integrantes-${teamId}">${numIntegrantes}</span></div>
                <div>Promedio: <span id="promedio-${teamId}">${promedio.toFixed(2)}</span></div>
                ${currentRole === "user" ? `<button class="btn" onclick="joinTeam('${teamId}')" ${selectedTeam ? "disabled" : ""}>Unirse</button>` : ""}
              </div>
            `;
          });
        }
        // Si ya seleccionó equipo, muestra pregunta
        if (selectedTeam && currentRole === "user") {
          document.getElementById("team-section").classList.add("hidden");
          if (!hasAnswered) {
            mostrarPregunta();
          } else {
            document.getElementById("waiting-section").classList.remove("hidden");
          }
        }
        // Si admin, actualiza panel
        if (isAdmin) actualizarAdminStatus();
      });
    }

    // Unirse a un equipo
    window.joinTeam = function(teamId) {
      if (!currentUser) return;
      selectedTeam = teamId;
      firebase.database().ref(`teams/${teamId}/members/${currentUser}`).set({
        displayName: currentUser,
        score: null
      });
      document.getElementById("team-section").classList.add("hidden");
      mostrarPregunta();
    };

    // Mostrar pregunta
    function mostrarPregunta() {
      document.getElementById("question-section").classList.remove("hidden");
      const q = questions[currentQuestion];
      document.getElementById("question-text").textContent = q.text;
      const optionsList = document.getElementById("options-list");
      optionsList.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt;
        btn.onclick = function() {
          document.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          document.getElementById("submit-answer").disabled = false;
          btn.dataset.selected = idx;
        };
        optionsList.appendChild(btn);
      });
      document.getElementById("submit-answer").disabled = true;
    }

    // Enviar respuesta
    function submitAnswer() {
      const selectedBtn = document.querySelector(".option-btn.selected");
      if (!selectedBtn) return;
      const selectedIdx = Array.from(document.querySelectorAll(".option-btn")).indexOf(selectedBtn);
      // Guarda la calificación (1 si correcta, 0 si incorrecta)
      const esCorrecta = selectedIdx === questions[currentQuestion].correct;
      firebase.database().ref(`teams/${selectedTeam}/members/${currentUser}/score`).set(esCorrecta ? 10 : 0);
      hasAnswered = true;
      document.getElementById("question-section").classList.add("hidden");
      document.getElementById("waiting-section").classList.remove("hidden");
      // Si admin, actualiza panel
      if (isAdmin) actualizarAdminStatus();
    }

    // Admin: finalizar juego
    function finalizarJuego() {
      firebase.database().ref('gameState').set({ finished: true });
    }

    // Mostrar resultados
    function mostrarResultados(teamsData) {
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("waiting-section").classList.add("hidden");
      document.getElementById("result-section").classList.remove("hidden");
      const tbody = document.getElementById("result-table-body");
      tbody.innerHTML = '';
      let maxProm = -1, ganador = [];
      teamIds.forEach(teamId => {
        const team = teamsData[teamId] || { members: {} };
        const integrantes = team.members ? Object.keys(team.members).length : 0;
        const scores = team.members ? Object.values(team.members).map(m => m.score ?? null).filter(s => s !== null) : [];
        const promedio = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
        if (promedio > maxProm) { maxProm = promedio; ganador = [teamNames[teamId]]; }
        else if (promedio === maxProm && promedio > 0) { ganador.push(teamNames[teamId]); }
        tbody.innerHTML += `
          <tr${promedio === maxProm && promedio > 0 ? ' class="winner"' : ''}>
            <td>${teamNames[teamId]}</td>
            <td>${integrantes}</td>
            <td>${promedio.toFixed(2)}</td>
          </tr>
        `;
      });
      document.getElementById("winner-msg").innerHTML = ganador.length && maxProm > 0
        ? `¡Equipo ganador: <b>${ganador.join(', ')}</b>!`
        : "No hay equipo ganador.";
    }

    // Admin: ver estado de respuestas
    function actualizarAdminStatus() {
      firebase.database().ref('teams').once('value', snap => {
        const teamsData = snap.val() || {};
        let total = 0, respondidos = 0;
        teamIds.forEach(teamId => {
          const team = teamsData[teamId] || { members: {} };
          const miembros = team.members ? Object.values(team.members) : [];
          total += miembros.length;
          respondidos += miembros.filter(m => m.score !== null).length;
        });
        document.getElementById("admin-status").innerHTML =
          `<p>Participantes: <b>${total}</b> | Han respondido: <b>${respondidos}</b></p>`;
      });
    }

    // Escuchar finalización del juego o respuestas completas
    firebase.database().ref('gameState').on('value', snap => {
      const state = snap.val();
      if (state && state.finished) {
        firebase.database().ref('teams').once('value', snap2 => {
          mostrarResultados(snap2.val() || {});
        });
      }
    });

    // Para mostrar resultados automáticamente si todos respondieron
    firebase.database().ref('teams').on('value', snap => {
      const teamsData = snap.val() || {};
      let total = 0, respondidos = 0;
      teamIds.forEach(teamId => {
        const team = teamsData[teamId] || { members: {} };
        const miembros = team.members ? Object.values(team.members) : [];
        total += miembros.length;
        respondidos += miembros.filter(m => m.score !== null).length;
      });
      if (total > 0 && total === respondidos) {
        firebase.database().ref('gameState').set({ finished: true });
      }
    });

  </script>
</body>
</html>
