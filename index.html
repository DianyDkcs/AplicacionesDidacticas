// Juego de Estadística Profesional - Flujo Completo
// Simula multiusuario y persistencia local
const { useState, useEffect } = React;

// Utilidades
function generateSessionCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
  return code;
}

function getInitialData() {
  // Carga de localStorage o valores por defecto
  const data = localStorage.getItem("estadisticaGameData");
  if (data) return JSON.parse(data);
  return {
    sessions: {},
    adminPassword: "admin123",
    theme: "light"
  };
}

function saveData(data) {
  localStorage.setItem("estadisticaGameData", JSON.stringify(data));
}

const defaultTeams = [
  { id: "A", name: "Equipo A", members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 },
  { id: "B", name: "Equipo B", members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 },
  { id: "C", name: "Equipo C", members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 },
  { id: "D", name: "Equipo D", members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 },
  { id: "E", name: "Equipo E", members: [], score: 0, questionsAnswered: 0, correctAnswers: 0 }
];

const questions = [
  {
    question: "¿Qué representa el valor p en un estudio sobre la eficacia de un nuevo antibiótico?",
    options: [
      "La probabilidad de que el antibiótico sea efectivo",
      "La probabilidad de obtener los resultados observados si el antibiótico no tiene efecto",
      "El porcentaje de vacas que se curaron",
      "El nivel de significancia"
    ],
    correctIndex: 1,
    explanation: "El valor p representa la probabilidad de obtener los resultados observados (o más extremos) si la hipótesis nula fuera cierta."
  },
  {
    question: "En un estudio sobre el efecto de un suplemento alimenticio en el peso de terneros, se obtuvo un valor p de 0.03. ¿Qué significa esto?",
    options: [
      "El suplemento aumenta el peso en un 3%",
      "Hay un 3% de probabilidad de que el suplemento sea efectivo",
      "Hay un 3% de probabilidad de obtener estos resultados si el suplemento no tiene efecto",
      "El 3% de los terneros respondieron al suplemento"
    ],
    correctIndex: 2,
    explanation: "Un valor p de 0.03 significa que hay un 3% de probabilidad de obtener estos resultados si la hipótesis nula fuera cierta."
  },
  {
    question: "¿Qué es el valor crítico en una prueba de hipótesis?",
    options: [
      "El número mínimo de animales que deben ser vacunados",
      "El valor que determina el límite entre rechazar o no rechazar la hipótesis nula",
      "El porcentaje mínimo de eficacia que debe tener la vacuna",
      "La dosis mínima efectiva de la vacuna"
    ],
    correctIndex: 1,
    explanation: "El valor crítico es el punto de corte en la distribución de probabilidad que separa la región de rechazo de la región de no rechazo de la hipótesis nula."
  },
  {
    question: "¿Cuándo se rechaza la hipótesis nula en un estudio?",
    options: [
      "Cuando el valor p es mayor que el nivel de significancia",
      "Cuando el valor p es menor que el nivel de significancia",
      "Cuando el valor p es igual a 0.5",
      "Cuando el estadístico de prueba está dentro de la región de aceptación"
    ],
    correctIndex: 1,
    explanation: "Se rechaza la hipótesis nula cuando el valor p es menor que el nivel de significancia (α) establecido."
  }
];

function App() {
  // Estado global
  const [data, setData] = useState(getInitialData());
  const [theme, setTheme] = useState(data.theme || "light");
  const [view, setView] = useState("login"); // login, admin, student, team, game, results
  const [role, setRole] = useState("student");
  const [adminPass, setAdminPass] = useState("");
  const [sessionCode, setSessionCode] = useState("");
  const [studentName, setStudentName] = useState("");
  const [selectedTeam, setSelectedTeam] = useState(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedOption, setSelectedOption] = useState(null);
  const [showExplanation, setShowExplanation] = useState(false);
  const [studentSession, setStudentSession] = useState(null); // {code, teamId, name, answers: []}
  const [confetti, setConfetti] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [newAdminPass, setNewAdminPass] = useState("");
  const [copySuccess, setCopySuccess] = useState(false);
  const [nameError, setNameError] = useState(false);

  // Sincronización localStorage
  useEffect(() => {
    saveData(data);
  }, [data]);

  useEffect(() => {
    document.body.style.background = theme === "dark" ? "#222" : "#f5f5f5";
  }, [theme]);

  // Autollenar código de sesión desde la URL y cambiar vista
  useEffect(() => {
    try {
      const params = new URLSearchParams(window.location.search);
      const session = params.get('session');
      if (session) {
        const sessionCode = session.toUpperCase();
        setSessionCode(sessionCode);
        setRole("student");
        
        // Verificar si la sesión existe en los datos
        const sessionData = data.sessions[sessionCode];
        if (sessionData) {
          // Si la sesión existe, ir directamente a la vista de estudiante
          setView("student");
        }
      }
    } catch (e) {
      console.error("Error al leer parámetros de URL:", e);
    }
  }, [data.sessions]);

  // --- LOGIN ---
  function handleLogin() {
    if (role === "admin") {
      if (adminPass === data.adminPassword) {
        setView("admin");
        setSessionCode(data.lastSession || "");
      } else {
        alert("Contraseña incorrecta");
      }
    } else {
      if (sessionCode.length === 6) {
        // Verificar si la sesión existe
        if (data.sessions[sessionCode]) {
          setView("student");
        } else {
          alert("Código de sesión no encontrado");
        }
      } else {
        alert("Código de sesión inválido");
      }
    }
  }

  // --- ADMIN ---
  function handleStartSession() {
    const code = generateSessionCode();
    const session = {
      code,
      started: true,
      finished: false,
      teams: JSON.parse(JSON.stringify(defaultTeams)),
      leaderboard: [],
      questions: questions.map(q => ({ ...q })),
      answers: {}
    };
    setData(d => ({ ...d, sessions: { ...d.sessions, [code]: session }, lastSession: code }));
    setSessionCode(code);
  }

  function handleEndSession() {
    if (!sessionCode) return;
    
    // Marcar la sesión como finalizada
    setData(d => {
      const s = { ...d.sessions[sessionCode], finished: true };
      return { ...d, sessions: { ...d.sessions, [sessionCode]: s } };
    });
    
    // Volver a la pantalla de login
    setSessionCode("");
    setView("login");
  }

  // Función para copiar el código de sesión
  function copySessionCode() {
    if (!sessionCode) return;
    
    // Usar el API de portapapeles si está disponible
    if (navigator.clipboard) {
      navigator.clipboard.writeText(sessionCode)
        .then(() => {
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
        })
        .catch(err => {
          console.error('Error al copiar: ', err);
          alert("No se pudo copiar el código. Cópialo manualmente: " + sessionCode);
        });
    } else {
      // Fallback para navegadores que no soportan clipboard API
      const textArea = document.createElement("textarea");
      textArea.value = sessionCode;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      } catch (err) {
        console.error('Error al copiar: ', err);
        alert("No se pudo copiar el código. Cópialo manualmente: " + sessionCode);
      }
      
      document.body.removeChild(textArea);
    }
  }

  // Función para copiar el enlace completo
  function copySessionLink() {
    if (!sessionCode) return;
    
    const fullLink = window.location.href.split('?')[0] + '?session=' + sessionCode;
    
    if (navigator.clipboard) {
      navigator.clipboard.writeText(fullLink)
        .then(() => {
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
        })
        .catch(err => {
          console.error('Error al copiar: ', err);
          alert("No se pudo copiar el enlace. Cópialo manualmente: " + fullLink);
        });
    } else {
      const textArea = document.createElement("textarea");
      textArea.value = fullLink;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      } catch (err) {
        console.error('Error al copiar: ', err);
        alert("No se pudo copiar el enlace. Cópialo manualmente: " + fullLink);
      }
      
      document.body.removeChild(textArea);
    }
  }

  // --- STUDENT ---
  function handleJoinTeam(teamId) {
    if (!studentName.trim()) {
      setNameError(true);
      return;
    }
    
    setNameError(false);
    const session = data.sessions[sessionCode];
    if (!session) return alert("Sesión no encontrada");
    
    // Evitar duplicados
    const teams = session.teams.map(t => {
      if (t.id === teamId && !t.members.includes(studentName)) {
        return { ...t, members: [...t.members, studentName] };
      }
      if (t.members.includes(studentName)) {
        return { ...t, members: t.members.filter(n => n !== studentName) };
      }
      return t;
    });
    
    setData(d => {
      const s = { ...session, teams };
      return { ...d, sessions: { ...d.sessions, [sessionCode]: s } };
    });
    
    setSelectedTeam(teamId);
    setView("game");
    setStudentSession({ code: sessionCode, teamId, name: studentName, answers: [] });
    setCurrentQuestion(0);
  }

  // --- GAME ---
  function handleAnswer(optionIdx) {
    setSelectedOption(optionIdx);
    setShowExplanation(true);
    // Guardar respuesta
    setStudentSession(s => {
      const answers = [...(s.answers || [])];
      answers[currentQuestion] = optionIdx;
      return { ...s, answers };
    });
    // Actualizar score en data
    setData(d => {
      const session = d.sessions[sessionCode];
      const teams = session.teams.map(t => {
        if (t.id === selectedTeam) {
          let correct = t.correctAnswers;
          let score = t.score;
          if (optionIdx === questions[currentQuestion].correctIndex) {
            correct++;
            score += 10;
          }
          return {
            ...t,
            questionsAnswered: t.questionsAnswered + 1,
            correctAnswers: correct,
            score
          };
        }
        return t;
      });
      return {
        ...d,
        sessions: {
          ...d.sessions,
          [sessionCode]: { ...session, teams }
        }
      };
    });
  }

  function handleNext() {
    setShowExplanation(false);
    setSelectedOption(null);
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(q => q + 1);
    } else {
      setView("results");
      setConfetti(true);
    }
  }

  // --- SETTINGS ---
  function handleSavePassword() {
    if (newAdminPass.length < 4) return alert("Contraseña muy corta");
    setData(d => ({ ...d, adminPassword: newAdminPass }));
    setNewAdminPass("");
    alert("Contraseña cambiada");
  }

  function handleThemeChange(e) {
    setTheme(e.target.value);
    setData(d => ({ ...d, theme: e.target.value }));
  }

  function handleResetData() {
    if (window.confirm("¿Seguro que quieres borrar todos los datos?")) {
      localStorage.removeItem("estadisticaGameData");
      window.location.reload();
    }
  }

  // --- RENDER ---
  return (
    <div className={theme === "dark" ? "bg-gray-900 text-white min-h-screen" : "min-h-screen"}>
      <h1 className="text-2xl font-bold text-center my-4">Juego de Estadística</h1>
      {view === "login" && (
        <div className="max-w-md mx-auto bg-white p-6 rounded shadow">
          <label>Rol:
            <select value={role} onChange={e => setRole(e.target.value)} className="ml-2">
              <option value="admin">Administrador</option>
              <option value="student">Estudiante</option>
            </select>
          </label>
          {role === "admin" ? (
            <div className="mt-4">
              <input type="password" placeholder="Contraseña admin" value={adminPass} onChange={e => setAdminPass(e.target.value)} className="w-full p-2 border rounded" />
            </div>
          ) : (
            <>
              <div className="mt-4">
                <input type="text" placeholder="Código de sesión" value={sessionCode} onChange={e => setSessionCode(e.target.value.toUpperCase())} className="w-full p-2 border rounded" maxLength={6} />
              </div>
              <div className="mt-4">
                <input type="text" placeholder="Tu nombre" value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full p-2 border rounded" />
              </div>
            </>
          )}
          <button className="mt-4 w-full bg-blue-600 text-white p-2 rounded" onClick={handleLogin}>Ingresar</button>
        </div>
      )}
      {view === "admin" && (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow">
          <h2 className="text-xl font-bold mb-2">Panel de Administrador</h2>
          
          {/* Código de sesión con botón de copiar */}
          {sessionCode ? (
            <div className="mb-4 p-3 bg-gray-100 rounded flex items-center justify-between">
              <div>
                <div className="text-sm text-gray-600">Código de sesión:</div>
                <div className="font-mono text-lg font-bold">{sessionCode}</div>
              </div>
              <button 
                className={`px-3 py-1 rounded text-white ${copySuccess ? 'bg-green-600' : 'bg-blue-600'}`}
                onClick={copySessionCode}
              >
                {copySuccess ? '¡Copiado!' : 'Copiar'}
              </button>
            </div>
          ) : (
            <div className="mb-4">No hay sesión activa</div>
          )}
          
          <div className="flex mb-4">
            <button className="bg-green-600 text-white p-2 rounded mr-2" onClick={handleStartSession}>
              {sessionCode ? 'Nueva sesión' : 'Iniciar juego'}
            </button>
            {sessionCode && (
              <button className="bg-red-600 text-white p-2 rounded" onClick={handleEndSession}>
                Finalizar sesión
              </button>
            )}
          </div>
          
          {/* Instrucciones para compartir */}
          {sessionCode && (
            <div className="mb-4 p-3 bg-blue-50 rounded text-sm">
              <p className="font-bold">Compartir con estudiantes:</p>
              <ol className="list-decimal ml-5 mt-1">
                <li>Comparte el código: <strong>{sessionCode}</strong></li>
                <li>O comparte este enlace:
                  <div className="flex items-center mt-1">
                    <div className="font-mono bg-white p-1 text-xs break-all border rounded flex-grow mr-1">
                      {window.location.href.split('?')[0]}?session={sessionCode}
                    </div>
                    <button 
                      className="px-2 py-1 bg-blue-600 text-white text-xs rounded"
                      onClick={copySessionLink}
                    >
                      Copiar
                    </button>
                  </div>
                </li>
                <li>Los estudiantes deben ingresar como "Estudiante" y usar el código</li>
              </ol>
              
              {/* QR Code simulado */}
              <div className="mt-3 p-2 bg-white border rounded text-center">
                <div className="text-xs mb-1">Código QR (ilustrativo)</div>
                <div className="w-32 h-32 mx-auto bg-gray-200 flex items-center justify-center">
                  <div className="text-3xl">QR</div>
                </div>
                <div className="text-xs mt-1">En una implementación real, aquí aparecería un código QR escaneble</div>
              </div>
            </div>
          )}
          
          <div className="mt-4">
            <h3 className="font-bold">Equipos</h3>
            <div className="grid grid-cols-2 gap-2">
              {(data.sessions[sessionCode]?.teams || defaultTeams).map(t => (
                <div key={t.id} className="border rounded p-2">
                  <div className="font-bold">{t.name}</div>
                  <div>Integrantes: {t.members.length}</div>
                  <div>Puntos: {t.score}</div>
                </div>
              ))}
            </div>
          </div>
          <div className="mt-4">
            <h3 className="font-bold">Clasificación</h3>
            <table className="w-full text-sm">
              <thead><tr><th>Equipo</th><th>Puntos</th><th>Correctas</th></tr></thead>
              <tbody>
                {(data.sessions[sessionCode]?.teams || defaultTeams)
                  .slice().sort((a,b)=>b.score-a.score)
                  .map(t => (
                  <tr key={t.id}><td>{t.name}</td><td>{t.score}</td><td>{t.correctAnswers}</td></tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="mt-4">
            <button className="bg-gray-700 text-white p-2 rounded" onClick={()=>setShowSettings(s=>!s)}>Configuración</button>
            {showSettings && (
              <div className="mt-2 p-2 border rounded">
                <div>
                  <input type="password" placeholder="Nueva contraseña admin" value={newAdminPass} onChange={e=>setNewAdminPass(e.target.value)} className="w-full p-2 border rounded" />
                  <button className="bg-blue-600 text-white p-2 rounded mt-2" onClick={handleSavePassword}>Guardar contraseña</button>
                </div>
                <div className="mt-2">
                  <label>Tema: </label>
                  <select value={theme} onChange={handleThemeChange}>
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                  </select>
                </div>
                <button className="bg-red-600 text-white p-2 rounded mt-2" onClick={handleResetData}>Reiniciar datos</button>
              </div>
            )}
          </div>
        </div>
      )}
      {view === "student" && (
        <div className="max-w-md mx-auto bg-white p-6 rounded shadow">
          <h2 className="text-xl font-bold mb-2">Unirse al juego</h2>
          
          {/* Información de la sesión */}
          <div className="mb-4 p-2 bg-blue-50 rounded">
            <div className="text-sm">Sesión: <span className="font-mono font-bold">{sessionCode}</span></div>
          </div>
          
          {/* Formulario de nombre */}
          <div className="mb-4">
            <label className="block text-sm font-medium mb-1">Tu nombre:</label>
            <input 
              type="text" 
              placeholder="Escribe tu nombre" 
              value={studentName} 
              onChange={e => {
                setStudentName(e.target.value);
                if (e.target.value.trim()) setNameError(false);
              }} 
              className={`w-full p-2 border rounded ${nameError ? 'border-red-500' : ''}`} 
            />
            {nameError && <div className="text-red-500 text-xs mt-1">Debes ingresar tu nombre</div>}
          </div>
          
          <h3 className="font-bold mb-2">Selecciona tu equipo:</h3>
          <div className="grid grid-cols-2 gap-2">
            {(data.sessions[sessionCode]?.teams || defaultTeams).map(t => (
              <button 
                key={t.id} 
                className={`border rounded p-3 ${selectedTeam===t.id ? "bg-blue-200 border-blue-500" : ""}`} 
                onClick={()=>handleJoinTeam(t.id)}
              >
                <div className="font-bold">{t.name}</div>
                <div className="text-sm">{t.members.length} integrantes</div>
              </button>
            ))}
          </div>
          
          {/* Instrucciones */}
          <div className="mt-4 text-sm text-gray-600">
            <p>1. Ingresa tu nombre</p>
            <p>2. Selecciona un equipo para comenzar</p>
          </div>
        </div>
      )}
      {view === "game" && (
        <div className="max-w-lg mx-auto bg-white p-6 rounded shadow">
          <h2 className="font-bold mb-2">Pregunta {currentQuestion+1} de {questions.length}</h2>
          <div className="mb-2 font-bold">{questions[currentQuestion].question}</div>
          <div className="grid grid-cols-1 gap-2">
            {questions[currentQuestion].options.map((opt, idx) => (
              <button key={idx} className={"border rounded p-2 text-left " + (selectedOption===idx? (idx===questions[currentQuestion].correctIndex?"bg-green-200":"bg-red-200") : "")} disabled={selectedOption!==null} onClick={()=>handleAnswer(idx)}>{opt}</button>
            ))}
          </div>
          {showExplanation && (
            <div className={selectedOption===questions[currentQuestion].correctIndex?"text-green-700 mt-2":"text-red-700 mt-2"}>
              {selectedOption===questions[currentQuestion].correctIndex?"¡Correcto!":"Incorrecto."} <br/>
              <span className="text-sm">{questions[currentQuestion].explanation}</span>
            </div>
          )}
          <div className="w-full bg-gray-200 rounded h-3 mt-4">
            <div className="bg-blue-600 h-3 rounded" style={{width:((currentQuestion+1)/questions.length*100)+"%"}}></div>
          </div>
          {showExplanation && <button className="mt-4 bg-blue-600 text-white p-2 rounded" onClick={handleNext}>{currentQuestion<questions.length-1?"Siguiente":"Ver resultado"}</button>}
        </div>
      )}
      {view === "results" && (
        <div className="max-w-lg mx-auto bg-white p-6 rounded shadow text-center">
          <h2 className="text-2xl font-bold mb-2">¡Juego finalizado!</h2>
          <div className="mb-2">Gracias por participar, <span className="font-bold">{studentName}</span> del <span className="font-bold">{defaultTeams.find(t=>t.id===selectedTeam)?.name}</span>.</div>
          <div className="mb-2">Puntaje: <span className="font-bold">{data.sessions[sessionCode]?.teams.find(t=>t.id===selectedTeam)?.score || 0}</span></div>
          {confetti && <Confetti />}
          <button className="mt-4 bg-blue-600 text-white p-2 rounded" onClick={()=>window.location.reload()}>Volver al inicio</button>
        </div>
      )}
    </div>
  );
}

// Animación de confeti
function Confetti() {
  useEffect(() => {
    const canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = 200;
    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.pointerEvents = 'none';
    canvas.style.zIndex = 9999;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let confetti = Array.from({length:100},()=>({x:Math.random()*canvas.width,y:Math.random()*-200,color:`hsl(${Math.random()*360},70%,60%)`,r:Math.random()*6+4,speed:Math.random()*2+1}));
    let running = true;
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confetti.forEach(c=>{
        ctx.beginPath();ctx.arc(c.x,c.y,c.r,0,2*Math.PI);ctx.fillStyle=c.color;ctx.fill();
        c.y+=c.speed;
        if(c.y>canvas.height) c.y=Math.random()*-20;
      });
      if(running) requestAnimationFrame(draw);
    }
    draw();
    return ()=>{running=false;canvas.remove();};
  },[]);
  return null;
}
