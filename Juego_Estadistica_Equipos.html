<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Estadística - Modo Competencia</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
        }
        .login-container, .admin-panel, .team-selection, .game-container {
            display: none;
        }
        .active {
            display: block;
        }
        .question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #eaf2f8;
            border-radius: 5px;
        }
        .options {
            margin-top: 10px;
        }
        .option {
            margin: 5px 0;
            padding: 10px;
            background-color: #d4e6f1;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .option:hover {
            background-color: #a9cce3;
        }
        .selected {
            background-color: #3498db;
            color: white;
        }
        .correct {
            background-color: #2ecc71;
            color: white;
        }
        .incorrect {
            background-color: #e74c3c;
            color: white;
        }
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .buttons {
            margin-top: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .progress {
            margin-top: 20px;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.5s;
        }
        .explanation {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9e79f;
            border-radius: 5px;
            display: none;
        }
        .image-container {
            text-align: center;
            margin: 15px 0;
        }
        .image-container img {
            max-width: 100%;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .team-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .team-card.selected-team {
            border: 3px solid #3498db;
        }
        .team-name {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .team-score {
            font-size: 1.2em;
            color: #2c3e50;
        }
        .admin-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf2f8;
            border-radius: 5px;
        }
        .team-progress {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            padding: 20px;
            background-color: #fff;
            border-radius: 0 0 5px 5px;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .leaderboard th, .leaderboard td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .leaderboard th {
            background-color: #3498db;
            color: white;
        }
        .leaderboard tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .leaderboard tr:hover {
            background-color: #e5e5e5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Juego de Estadística para Veterinaria y Zootecnia</h1>

        <!-- Pantalla de inicio de sesión -->
        <div id="login-container" class="login-container active">
            <h2>Iniciar Sesión</h2>
            <div class="input-group">
                <label for="user-type">Seleccione su rol:</label>
                <select id="user-type">
                    <option value="admin">Administrador</option>
                    <option value="student">Estudiante</option>
                </select>
            </div>
            <div id="admin-login-fields">
                <div class="input-group">
                    <label for="admin-email">Correo electrónico:</label>
                    <input type="email" id="admin-email" placeholder="admin@ejemplo.com">
                </div>
                <div class="input-group">
                    <label for="admin-password">Contraseña:</label>
                    <input type="password" id="admin-password" placeholder="********">
                </div>
            </div>
            <div id="student-login-fields" style="display: none;">
                <p>Escanea el código QR proporcionado por tu profesor o ingresa el código de la sesión:</p>
                <div class="input-group">
                    <label for="session-code">Código de sesión:</label>
                    <input type="text" id="session-code" placeholder="Ingresa el código de 6 dígitos">
                </div>
            </div>
            <div class="buttons">
                <button id="login-btn">Ingresar</button>
            </div>
        </div>

        <!-- Panel de administrador -->
        <div id="admin-panel" class="admin-panel">
            <h2>Panel de Administrador</h2>

            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="session-tab">Sesión</button>
                    <button class="tab-button" data-tab="teams-tab">Equipos</button>
                    <button class="tab-button" data-tab="progress-tab">Progreso</button>
                    <button class="tab-button" data-tab="results-tab">Resultados</button>
                </div>

                <div class="tab-content">
                    <!-- Pestaña de Sesión -->
                    <div id="session-tab" class="tab-panel active">
                        <h3>Información de la Sesión</h3>
                        <div class="session-info">
                            <p>Código de sesión: <span id="session-id">Generando...</span></p>
                            <div class="qr-container">
                                <h4>Código QR para acceso de estudiantes</h4>
                                <div id="qrcode"></div>
                                <p>Los estudiantes pueden escanear este código QR o ingresar el código de sesión manualmente.</p>
                            </div>
                            <div class="admin-controls">
                                <h4>Controles de Sesión</h4>
                                <button id="start-session-btn">Iniciar Sesión</button>
                                <button id="pause-session-btn">Pausar Sesión</button>
                                <button id="end-session-btn">Finalizar Sesión</button>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña de Equipos -->
                    <div id="teams-tab" class="tab-panel">
                        <h3>Gestión de Equipos</h3>
                        <div class="input-group">
                            <label for="new-team-name">Nombre del nuevo equipo:</label>
                            <input type="text" id="new-team-name" placeholder="Ej: Equipo Alfa">
                            <button id="add-team-btn">Agregar Equipo</button>
                        </div>
                        <div id="teams-list" class="team-grid">
                            <!-- Los equipos se cargarán dinámicamente aquí -->
                        </div>
                    </div>

                    <!-- Pestaña de Progreso -->
                    <div id="progress-tab" class="tab-panel">
                        <h3>Progreso de los Equipos</h3>
                        <div id="teams-progress">
                            <!-- El progreso de los equipos se cargará dinámicamente aquí -->
                        </div>
                    </div>

                    <!-- Pestaña de Resultados -->
                    <div id="results-tab" class="tab-panel">
                        <h3>Tabla de Clasificación</h3>
                        <table class="leaderboard">
                            <thead>
                                <tr>
                                    <th>Posición</th>
                                    <th>Equipo</th>
                                    <th>Preguntas Respondidas</th>
                                    <th>Respuestas Correctas</th>
                                    <th>Puntuación</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body">
                                <!-- Los resultados se cargarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selección de equipo para estudiantes -->
        <div id="team-selection" class="team-selection">
            <h2>Selecciona tu Equipo</h2>
            <div id="student-teams-grid" class="team-grid">
                <!-- Los equipos se cargarán dinámicamente aquí -->
            </div>
            <div class="buttons">
                <button id="join-team-btn" disabled>Unirse al Equipo</button>
            </div>
        </div>

        <!-- Contenedor del juego -->
        <div id="game-container" class="game-container">
            <div class="team-info">
                <h3>Equipo: <span id="current-team-name">-</span></h3>
                <div class="progress">
                    <div class="progress-bar" id="progress"></div>
                </div>
            </div>

            <div id="question-container" class="question">
                <h3 id="question-text">Pregunta aparecerá aquí</h3>
                <div class="image-container" id="question-image-container">
                    <!-- La imagen se insertará aquí si es necesario -->
                </div>
                <div class="options" id="options-container">
                    <!-- Las opciones se insertarán aquí -->
                </div>
                <div class="feedback" id="feedback"></div>
                <div class="explanation" id="explanation"></div>
            </div>

            <div class="buttons">
                <button id="check-btn">Comprobar</button>
                <button id="next-btn" disabled>Siguiente</button>
            </div>

            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        // Configuración de Firebase (reemplazar con tus propias credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyDEMOKEY",
            authDomain: "estadistica-juego.firebaseapp.com",
            databaseURL: "https://estadistica-juego-default-rtdb.firebaseio.com",
            projectId: "estadistica-juego",
            storageBucket: "estadistica-juego.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Inicializar Firebase (comentado para evitar errores, ya que no tenemos credenciales reales)
        // firebase.initializeApp(firebaseConfig);

        // Simulación de base de datos para el prototipo
        const simulatedDB = {
            sessions: {
                "ABC123": {
                    active: true,
                    startTime: Date.now(),
                    teams: {}
                }
            },
            teams: {
                "team1": { name: "Equipo Veterinaria", score: 0, questionsAnswered: 0, correctAnswers: 0 },
                "team2": { name: "Equipo Zootecnia", score: 0, questionsAnswered: 0, correctAnswers: 0 },
                "team3": { name: "Equipo Estadística", score: 0, questionsAnswered: 0, correctAnswers: 0 }
            }
        };

        // Generar un código de sesión aleatorio
        function generateSessionCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let code = "";
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Generar código QR
        function generateQRCode(text) {
            const qr = qrcode(0, 'M');
            qr.addData(text);
            qr.make();
            return qr.createImgTag(5);
        }

        // Preguntas del juego
        const questions = [
            {
                question: "¿Qué representa el valor p en un estudio sobre la eficacia de un nuevo antibiótico para tratar mastitis en vacas?",
                options: [
                    "La probabilidad de que el antibiótico sea efectivo",
                    "La probabilidad de obtener los resultados observados (o más extremos) si el antibiótico no tiene efecto",
                    "El porcentaje de vacas que se curaron con el antibiótico",
                    "El nivel de significancia establecido por el investigador"
                ],
                correctIndex: 1,
                explanation: "El valor p representa la probabilidad de obtener los resultados observados (o más extremos) si la hipótesis nula fuera cierta. En este caso, si el antibiótico realmente no tuviera efecto. Un valor p pequeño sugiere que es poco probable que los resultados se deban al azar.",
                image: "https://cdn.abacus.ai/images/7738cc8a-108f-44e1-a8a0-81ec96bd8772.png"
            },
            {
                question: "En un estudio sobre el efecto de un suplemento alimenticio en el peso de terneros, se obtuvo un valor p de 0.03. ¿Qué significa esto?",
                options: [
                    "El suplemento aumenta el peso en un 3%",
                    "Hay un 3% de probabilidad de que el suplemento sea efectivo",
                    "Hay un 3% de probabilidad de obtener estos resultados (o más extremos) si el suplemento no tiene efecto",
                    "El 3% de los terneros respondieron al suplemento"
                ],
                correctIndex: 2,
                explanation: "Un valor p de 0.03 significa que hay un 3% de probabilidad de obtener estos resultados (o más extremos) si la hipótesis nula fuera cierta (si el suplemento no tuviera efecto). Como es menor que el nivel de significancia típico de 0.05, generalmente se consideraría estadísticamente significativo.",
                image: null
            },
            {
                question: "¿Qué es el valor crítico en una prueba de hipótesis sobre la eficacia de una vacuna en cerdos?",
                options: [
                    "El número mínimo de cerdos que deben ser vacunados",
                    "El valor que determina el límite entre rechazar o no rechazar la hipótesis nula",
                    "El porcentaje mínimo de eficacia que debe tener la vacuna",
                    "La dosis mínima efectiva de la vacuna"
                ],
                correctIndex: 1,
                explanation: "El valor crítico es el punto de corte en la distribución de probabilidad que separa la región de rechazo de la región de no rechazo de la hipótesis nula. Si el estadístico de prueba es más extremo que el valor crítico, rechazamos la hipótesis nula.",
                image: "https://cdn.abacus.ai/images/c2d4ed73-1b0c-4fc9-8878-b9941b16bf3b.png"
            },
            {
                question: "En un estudio sobre dos métodos de inseminación artificial en bovinos, ¿qué significa un valor p = 0.08?",
                options: [
                    "Hay una diferencia significativa entre los dos métodos",
                    "No hay una diferencia significativa entre los dos métodos (asumiendo α = 0.05)",
                    "El método nuevo es 8% mejor que el método tradicional",
                    "Hay un 8% de probabilidad de que ambos métodos sean iguales"
                ],
                correctIndex: 1,
                explanation: "Un valor p de 0.08 es mayor que el nivel de significancia típico de 0.05, lo que significa que no rechazamos la hipótesis nula. Por lo tanto, no hay evidencia suficiente para afirmar que existe una diferencia significativa entre los dos métodos de inseminación.",
                image: null
            },
            {
                question: "¿Cuál de las siguientes afirmaciones sobre el valor p es INCORRECTA?",
                options: [
                    "Un valor p pequeño indica evidencia contra la hipótesis nula",
                    "El valor p es la probabilidad de que la hipótesis nula sea verdadera",
                    "El valor p se compara con el nivel de significancia (α) para tomar decisiones",
                    "Un valor p = 0.01 proporciona mayor evidencia contra la hipótesis nula que un valor p = 0.05"
                ],
                correctIndex: 1,
                explanation: "La afirmación incorrecta es que 'El valor p es la probabilidad de que la hipótesis nula sea verdadera'. El valor p NO indica la probabilidad de que la hipótesis nula sea verdadera o falsa. Es la probabilidad de obtener los resultados observados (o más extremos) si la hipótesis nula fuera cierta.",
                image: null
            },
            {
                question: "En un experimento sobre el efecto de un nuevo alimento en el peso de pollos, se obtuvo el siguiente resultado. ¿Qué conclusión es correcta?",
                options: [
                    "No hay diferencia significativa entre los dos alimentos",
                    "El nuevo alimento produce un aumento significativo en el peso de los pollos",
                    "El alimento tradicional es mejor que el nuevo",
                    "No se puede determinar sin conocer el valor p"
                ],
                correctIndex: 1,
                explanation: "La imagen muestra una diferencia estadísticamente significativa (indicada por el asterisco) entre el grupo control y el grupo con el nuevo alimento. El nuevo alimento produce un aumento significativo en el peso de los pollos.",
                image: "https://cdn.abacus.ai/images/4f3a871a-7027-422d-bcf4-e0d9a1349caf.png"
            },
            {
                question: "Si en un estudio sobre la eficacia de una vacuna contra la fiebre aftosa en bovinos se establece α = 0.01, ¿qué significa esto?",
                options: [
                    "La vacuna debe tener al menos 1% de eficacia",
                    "Se acepta un 1% de probabilidad de concluir incorrectamente que la vacuna es efectiva cuando no lo es",
                    "La vacuna debe funcionar en al menos el 99% de los animales",
                    "El 1% de los animales no responderá a la vacuna"
                ],
                correctIndex: 1,
                explanation: "El nivel de significancia (α) representa la probabilidad máxima que estamos dispuestos a aceptar de cometer un error Tipo I, es decir, rechazar incorrectamente la hipótesis nula cuando es verdadera. En este caso, estamos dispuestos a aceptar un 1% de probabilidad de concluir que la vacuna es efectiva cuando en realidad no lo es.",
                image: null
            },
            {
                question: "Observa la siguiente gráfica sobre el efecto de una vacuna en bovinos. ¿Qué conclusión es correcta?",
                options: [
                    "La vacuna no tiene efecto significativo",
                    "La vacuna reduce significativamente la enfermedad",
                    "La vacuna aumenta la enfermedad",
                    "No se puede determinar el efecto sin más información"
                ],
                correctIndex: 1,
                explanation: "La gráfica muestra una diferencia estadísticamente significativa (p < 0.001, indicado por ***) entre el grupo vacunado y el no vacunado. El porcentaje de animales enfermos es significativamente menor en el grupo vacunado, lo que indica que la vacuna reduce significativamente la enfermedad.",
                image: "https://cdn.abacus.ai/images/80e9d2b8-9112-4bd2-aafc-683ea1a7bd5e.png"
            },
            {
                question: "¿Cuándo se rechaza la hipótesis nula en un estudio sobre el efecto de un suplemento en la producción de leche?",
                options: [
                    "Cuando el valor p es mayor que el nivel de significancia",
                    "Cuando el valor p es menor que el nivel de significancia",
                    "Cuando el valor p es igual a 0.5",
                    "Cuando el estadístico de prueba está dentro de la región de aceptación"
                ],
                correctIndex: 1,
                explanation: "Se rechaza la hipótesis nula cuando el valor p es menor que el nivel de significancia (α) establecido. Esto indica que es poco probable que los resultados observados se deban al azar si la hipótesis nula fuera cierta.",
                image: "https://cdn.abacus.ai/images/22d8cb1a-78ad-42de-8027-9d498ba6368a.png"
            },
            {
                question: "En un estudio sobre dos razas de ganado, se obtuvo un valor p = 0.002 al comparar su ganancia diaria de peso. ¿Qué significa esto?",
                options: [
                    "Las razas son 0.2% diferentes en su ganancia de peso",
                    "Hay un 0.2% de probabilidad de que las razas sean iguales",
                    "Hay un 0.2% de probabilidad de obtener estos resultados (o más extremos) si no hubiera diferencia entre las razas",
                    "La diferencia entre las razas es de 0.002 kg por día"
                ],
                correctIndex: 2,
                explanation: "Un valor p de 0.002 significa que hay un 0.2% de probabilidad de obtener estos resultados (o más extremos) si la hipótesis nula fuera cierta (si no hubiera diferencia real entre las razas). Este valor p tan pequeño proporciona fuerte evidencia contra la hipótesis nula, sugiriendo que realmente existe una diferencia en la ganancia de peso entre las dos razas.",
                image: null
            }
        ];

        // Variables del juego
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOptionIndex = null;
        let answeredQuestions = 0;
        let currentTeam = null;
        let sessionCode = generateSessionCode();

        // Elementos del DOM
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const teamSelection = document.getElementById('team-selection');
        const gameContainer = document.getElementById('game-container');

        const userTypeSelect = document.getElementById('user-type');
        const adminLoginFields = document.getElementById('admin-login-fields');
        const studentLoginFields = document.getElementById('student-login-fields');
        const loginBtn = document.getElementById('login-btn');

        const sessionIdElement = document.getElementById('session-id');
        const qrcodeElement = document.getElementById('qrcode');
        const startSessionBtn = document.getElementById('start-session-btn');
        const pauseSessionBtn = document.getElementById('pause-session-btn');
        const endSessionBtn = document.getElementById('end-session-btn');

        const newTeamNameInput = document.getElementById('new-team-name');
        const addTeamBtn = document.getElementById('add-team-btn');
        const teamsListElement = document.getElementById('teams-list');
        const studentTeamsGrid = document.getElementById('student-teams-grid');
        const joinTeamBtn = document.getElementById('join-team-btn');

        const teamsProgressElement = document.getElementById('teams-progress');
        const leaderboardBody = document.getElementById('leaderboard-body');

        const currentTeamNameElement = document.getElementById('current-team-name');
        const questionText = document.getElementById('question-text');
        const questionImageContainer = document.getElementById('question-image-container');
        const optionsContainer = document.getElementById('options-container');
        const feedbackElement = document.getElementById('feedback');
        const explanationElement = document.getElementById('explanation');
        const checkButton = document.getElementById('check-btn');
        const nextButton = document.getElementById('next-btn');
        const resultElement = document.getElementById('result');
        const progressBar = document.getElementById('progress');

        // Cambiar entre tipos de usuario
        userTypeSelect.addEventListener('change', function() {
            if (this.value === 'admin') {
                adminLoginFields.style.display = 'block';
                studentLoginFields.style.display = 'none';
            } else {
                adminLoginFields.style.display = 'none';
                studentLoginFields.style.display = 'block';
            }
        });

        // Iniciar sesión
        loginBtn.addEventListener('click', function() {
            const userType = userTypeSelect.value;

            if (userType === 'admin') {
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;

                // En un sistema real, aquí se verificarían las credenciales
                // Para el prototipo, simplemente permitimos el acceso
                loginContainer.classList.remove('active');
                adminPanel.classList.add('active');

                // Mostrar código de sesión y QR
                sessionIdElement.textContent = sessionCode;
                qrcodeElement.innerHTML = generateQRCode(window.location.href + '?session=' + sessionCode);

                // Cargar equipos
                loadTeams();
                updateLeaderboard();

            } else {
                const code = document.getElementById('session-code').value;

                // En un sistema real, aquí se verificaría el código de sesión
                // Para el prototipo, simplemente permitimos el acceso
                loginContainer.classList.remove('active');
                teamSelection.classList.add('active');

                // Cargar equipos para selección
                loadTeamsForSelection();
            }
        });

        // Cambiar entre pestañas del panel de administrador
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // Desactivar todas las pestañas
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });

                // Activar la pestaña seleccionada
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                // Actualizar contenido de la pestaña
                if (tabId === 'progress-tab') {
                    updateTeamsProgress();
                } else if (tabId === 'results-tab') {
                    updateLeaderboard();
                }
            });
        });

        // Agregar equipo
        addTeamBtn.addEventListener('click', function() {
            const teamName = newTeamNameInput.value.trim();

            if (teamName) {
                const teamId = 'team' + (Object.keys(simulatedDB.teams).length + 1);
                simulatedDB.teams[teamId] = {
                    name: teamName,
                    score: 0,
                    questionsAnswered: 0,
                    correctAnswers: 0
                };

                newTeamNameInput.value = '';
                loadTeams();
                updateLeaderboard();
            }
        });

        // Unirse a un equipo
        joinTeamBtn.addEventListener('click', function() {
            teamSelection.classList.remove('active');
            gameContainer.classList.add('active');

            currentTeamNameElement.textContent = simulatedDB.teams[currentTeam].name;
            startGame();
        });

        // Cargar equipos para el panel de administrador
        function loadTeams() {
            teamsListElement.innerHTML = '';

            for (const teamId in simulatedDB.teams) {
                const team = simulatedDB.teams[teamId];

                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <div class="team-name">${team.name}</div>
                    <div class="team-score">Puntuación: ${team.score}</div>
                    <button class="edit-team-btn" data-team-id="${teamId}">Editar</button>
                    <button class="delete-team-btn" data-team-id="${teamId}">Eliminar</button>
                `;

                teamsListElement.appendChild(teamCard);
            }

            // Agregar eventos a los botones de editar y eliminar
            document.querySelectorAll('.edit-team-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const teamId = this.getAttribute('data-team-id');
                    const newName = prompt('Nuevo nombre para el equipo:', simulatedDB.teams[teamId].name);

                    if (newName && newName.trim()) {
                        simulatedDB.teams[teamId].name = newName.trim();
                        loadTeams();
                        updateLeaderboard();
                    }
                });
            });

            document.querySelectorAll('.delete-team-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const teamId = this.getAttribute('data-team-id');

                    if (confirm(`¿Estás seguro de eliminar el equipo "${simulatedDB.teams[teamId].name}"?`)) {
                        delete simulatedDB.teams[teamId];
                        loadTeams();
                        updateLeaderboard();
                    }
                });
            });
        }

        // Cargar equipos para selección de estudiantes
        function loadTeamsForSelection() {
            studentTeamsGrid.innerHTML = '';

            for (const teamId in simulatedDB.teams) {
                const team = simulatedDB.teams[teamId];

                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.setAttribute('data-team-id', teamId);
                teamCard.innerHTML = `
                    <div class="team-name">${team.name}</div>
                    <div class="team-members">Miembros: ${Math.floor(Math.random() * 5) + 1}</div>
                `;

                teamCard.addEventListener('click', function() {
                    // Desmarcar todos los equipos
                    document.querySelectorAll('.team-card').forEach(card => {
                        card.classList.remove('selected-team');
                    });

                    // Marcar el equipo seleccionado
                    this.classList.add('selected-team');
                    currentTeam = this.getAttribute('data-team-id');

                    // Habilitar botón de unirse
                    joinTeamBtn.disabled = false;
                });

                studentTeamsGrid.appendChild(teamCard);
            }
        }

        // Actualizar progreso de los equipos
        function updateTeamsProgress() {
            teamsProgressElement.innerHTML = '';

            for (const teamId in simulatedDB.teams) {
                const team = simulatedDB.teams[teamId];
                const progress = team.questionsAnswered / questions.length * 100;

                const teamProgressElement = document.createElement('div');
                teamProgressElement.className = 'team-progress';
                teamProgressElement.innerHTML = `
                    <div class="team-name">${team.name}</div>
                    <div>Preguntas respondidas: ${team.questionsAnswered} de ${questions.length}</div>
                    <div>Respuestas correctas: ${team.correctAnswers}</div>
                    <div class="progress">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                `;

                teamsProgressElement.appendChild(teamProgressElement);
            }
        }

        // Actualizar tabla de clasificación
        function updateLeaderboard() {
            // Ordenar equipos por puntuación
            const sortedTeams = Object.entries(simulatedDB.teams)
                .map(([id, team]) => ({ id, ...team }))
                .sort((a, b) => b.score - a.score);

            leaderboardBody.innerHTML = '';

            sortedTeams.forEach((team, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${team.name}</td>
                    <td>${team.questionsAnswered}</td>
                    <td>${team.correctAnswers}</td>
                    <td>${team.score}</td>
                `;

                leaderboardBody.appendChild(row);
            });
        }

        // Iniciar el juego
        function startGame() {
            currentQuestionIndex = 0;
            score = 0;
            answeredQuestions = 0;
            loadQuestion();
        }

        // Cargar pregunta actual
        function loadQuestion() {
            const currentQuestion = questions[currentQuestionIndex];

            // Actualizar texto de la pregunta
            questionText.textContent = currentQuestion.question;

            // Limpiar opciones anteriores
            optionsContainer.innerHTML = '';

            // Cargar imagen si existe
            if (currentQuestion.image) {
                questionImageContainer.innerHTML = `<img src="${currentQuestion.image}" alt="Imagen de la pregunta">`;
                questionImageContainer.style.display = 'block';
            } else {
                questionImageContainer.style.display = 'none';
            }

            // Crear opciones
            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.dataset.index = index;

                optionElement.addEventListener('click', () => {
                    // Desmarcar opción previamente seleccionada
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    // Marcar nueva opción seleccionada
                    optionElement.classList.add('selected');
                    selectedOptionIndex = index;

                    // Habilitar botón de comprobar
                    checkButton.disabled = false;
                });

                optionsContainer.appendChild(optionElement);
            });

            // Reiniciar estado
            selectedOptionIndex = null;
            feedbackElement.style.display = 'none';
            explanationElement.style.display = 'none';
            checkButton.disabled = true;
            nextButton.disabled = true;

            // Actualizar barra de progreso
            updateProgressBar();
        }

        // Comprobar respuesta
        function checkAnswer() {
            const currentQuestion = questions[currentQuestionIndex];
            const options = document.querySelectorAll('.option');

            // Marcar respuesta correcta e incorrecta
            options.forEach((option, index) => {
                if (index === currentQuestion.correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedOptionIndex) {
                    option.classList.add('incorrect');
                }
            });

            // Mostrar retroalimentación
            if (selectedOptionIndex === currentQuestion.correctIndex) {
                feedbackElement.textContent = '¡Correcto! 👍';
                feedbackElement.style.backgroundColor = '#2ecc71';
                score++;

                // Actualizar puntuación del equipo
                if (currentTeam) {
                    simulatedDB.teams[currentTeam].score += 10;
                    simulatedDB.teams[currentTeam].correctAnswers++;
                }
            } else {
                feedbackElement.textContent = '¡Incorrecto! La respuesta correcta está marcada en verde.';
                feedbackElement.style.backgroundColor = '#e74c3c';
            }

            // Mostrar explicación
            explanationElement.textContent = currentQuestion.explanation;

            // Mostrar elementos
            feedbackElement.style.display = 'block';
            explanationElement.style.display = 'block';

            // Actualizar botones
            checkButton.disabled = true;
            nextButton.disabled = false;

            // Actualizar contador de preguntas respondidas
            answeredQuestions++;

            // Actualizar estadísticas del equipo
            if (currentTeam) {
                simulatedDB.teams[currentTeam].questionsAnswered++;

                // En un sistema real, aquí se sincronizaría con Firebase
                updateTeamsProgress();
                updateLeaderboard();
            }

            // Verificar si es la última pregunta
            if (currentQuestionIndex === questions.length - 1) {
                nextButton.textContent = 'Ver Resultado';
            }
        }

        // Pasar a la siguiente pregunta
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                showResult();
            }
        }

        // Mostrar resultado final
        function showResult() {
            const percentage = Math.round((score / questions.length) * 100);

            // Ocultar contenedor de preguntas
            document.getElementById('question-container').style.display = 'none';

            // Mostrar resultado
            resultElement.innerHTML = `
                <h2>Resultado Final</h2>
                <p>Tu equipo ha acertado ${score} de ${questions.length} preguntas (${percentage}%)</p>
                <button id="restart-btn">Jugar de Nuevo</button>
                <button id="exit-btn">Salir</button>
            `;

            // Ocultar botones
            document.querySelector('.buttons').style.display = 'none';

            // Evento para reiniciar
            document.getElementById('restart-btn').addEventListener('click', () => {
                // Mostrar contenedor de preguntas
                document.getElementById('question-container').style.display = 'block';

                // Mostrar botones
                document.querySelector('.buttons').style.display = 'block';

                // Limpiar resultado
                resultElement.innerHTML = '';

                // Reiniciar juego
                startGame();
            });

            // Evento para salir
            document.getElementById('exit-btn').addEventListener('click', () => {
                gameContainer.classList.remove('active');
                teamSelection.classList.add('active');

                // Limpiar resultado
                resultElement.innerHTML = '';

                // Mostrar contenedor de preguntas para la próxima vez
                document.getElementById('question-container').style.display = 'block';

                // Mostrar botones para la próxima vez
                document.querySelector('.buttons').style.display = 'block';
            });
        }

        // Actualizar barra de progreso
        function updateProgressBar() {
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Eventos de los botones del juego
        checkButton.addEventListener('click', checkAnswer);
        nextButton.addEventListener('click', nextQuestion);

        // Eventos de los botones de sesión
        startSessionBtn.addEventListener('click', function() {
            alert('Sesión iniciada. Los estudiantes pueden unirse ahora.');
        });

        pauseSessionBtn.addEventListener('click', function() {
            alert('Sesión pausada. Los estudiantes no podrán avanzar hasta que se reanude.');
        });

        endSessionBtn.addEventListener('click', function() {
            if (confirm('¿Estás seguro de finalizar la sesión? Esto cerrará el juego para todos los estudiantes.')) {
                alert('Sesión finalizada.');
            }
        });

        // Verificar si hay un código de sesión en la URL (para estudiantes que acceden por QR)
        const urlParams = new URLSearchParams(window.location.search);
        const sessionFromUrl = urlParams.get('session');

        if (sessionFromUrl) {
            userTypeSelect.value = 'student';
            userTypeSelect.dispatchEvent(new Event('change'));
            document.getElementById('session-code').value = sessionFromUrl;
        }
    </script>
</body>
</html>
